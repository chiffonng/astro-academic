---
import { PROFILE, SITE } from "@site-config"

import { PostManager } from "@/lib/blog"
import { getLatestUpdates } from "@/lib/updates"
import Layout from "@/layouts/Layout.astro"
import Button from "@/components/base/Button.astro"
import Link from "@/components/base/Link.astro"
import PreviewCard from "@/components/blog/PreviewCard.astro"
import Section from "@/components/layout/Section.astro"
import Profile from "@/components/profile/Profile.astro"
import UpdateTimeline from "@/components/updates/UpdateTimeline.astro"

import { Content as MiscContent } from "@/content/misc.md"

// Updates
const renderedUpdates = await getLatestUpdates(3)

// Blog
const postManager = PostManager.getInstance()
const recentPosts = await postManager.getMainPosts(SITE.featuredPostCount)
const recentPostsMetadata = await Promise.all(
  recentPosts.map((post) => postManager.getMetadata(post.id))
)
---

<Layout title="Home">
  <Profile profile={PROFILE} />

  {
    renderedUpdates.length > 0 && (
      <Section>
        <div class="flex items-center gap-x-3">
          <h2 class="gap-y-4 text-2xl font-medium">Latest updates</h2>
          <Link href="/now" underline class="text-muted-foreground hover:text-foreground text-sm">
            see all &rarr;
          </Link>
        </div>
        <UpdateTimeline
          renderedUpdates={renderedUpdates}
          itemClass="line-clamp-4 md:line-clamp-3"
          variant="inline"
        />
      </Section>
    )
  }

  <Section title="Latest posts">
    {
      recentPostsMetadata.length > 0 ? (
        <>
          <ul class="flex flex-col gap-y-2">
            {recentPostsMetadata.map((metadata) => (
              <li>
                <PreviewCard metadata={metadata} />
              </li>
            ))}
          </ul>
          <div class="mt-4 flex justify-center gap-2">
            <Button href="/blog" variant="default" class="group">
              See all posts{" "}
              <span class="transition-transform group-hover:translate-x-1">&rarr;</span>
            </Button>
            <Button href="/tags" variant="ghost" class="group">
              Browse by tags{" "}
              <span class="transition-transform group-hover:translate-x-1">&rarr;</span>
            </Button>
          </div>
        </>
      ) : (
        <p class="text-muted-foreground py-8 text-center">
          No posts yet. Check back later for updates!
        </p>
      )
    }
  </Section>
  <Section title="Miscellaneous">
    <div class="prose"><MiscContent /></div>
  </Section>
</Layout>
